<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBB Travel Analyzer</title>
    <link rel="icon" type="image/svg+xml" href="tram-svgrepo-com.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1591359940131-e2a13a060253?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .backdrop-blur-sm {
             backdrop-filter: blur(4px);
        }
        .sbb-red { background-color: #EB0000; }
        .sbb-red-text { color: #EB0000; }
        .sbb-dark { color: #444; }
        
        /* Custom Loader Animation */
        .train-loader {
            width: 150px;
            height: 80px;
            position: relative;
        }
        .train-track {
            height: 4px;
            background-color: #666;
            width: 100%;
            position: absolute;
            bottom: 20px;
        }
        .train-body {
            width: 60px;
            height: 40px;
            background-color: #EB0000;
            border: 2px solid #333;
            border-radius: 8px 8px 0 0;
            position: absolute;
            bottom: 24px;
            left: 0;
            animation: move-train 2s linear infinite;
        }
        .train-window {
            width: 20px;
            height: 15px;
            background-color: #a2d2ff;
            position: absolute;
            top: 5px;
            left: 5px;
            border-radius: 2px;
        }
        .train-wheels {
            position: absolute;
            bottom: -8px;
            display: flex;
            gap: 12px;
        }
        .wheel {
            width: 16px;
            height: 16px;
            background-color: #555;
            border-radius: 50%;
            border: 2px solid #333;
        }
        .train-svg-loader {
            animation: move-train 2.5s linear infinite;
            width: 100%;
            max-width: 700px;
        }
        .train-wheel {
            transform-origin: center;
            animation: spin 1s linear infinite;
        }
        .smoke-puff {
            animation: smoke-puff 2.5s linear infinite;
        }
        .smoke-puff:nth-child(2) { animation-delay: 0.5s; }
        .smoke-puff:nth-child(3) { animation-delay: 1s; }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        @keyframes move-train {
            0% { transform: translateX(0); }
            100% { transform: translateX(60px); }
        }
        @keyframes smoke-puff {
            0% { opacity: 0.7; transform: scale(1) translateY(0); }
            60% { opacity: 0.5; transform: scale(1.2) translateY(-10px); }
            100% { opacity: 0; transform: scale(1.5) translateY(-30px); }
        }

        [contenteditable]:focus {
            outline: 2px solid #EB0000;
            background-color: #fff5f5;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        .content-card {
            background-color: rgba(255, 255, 255, 0.9);
            border-top: 4px solid #EB0000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-radius: 12px;
            backdrop-filter: blur(8px);
        }
        .bike-checkbox {
            cursor: pointer;
            width: 1.25rem;
            height: 1.25rem;
        }
        .animate-fade-in { animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row items-center justify-center mb-10 bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-200">
            <img src="tram-svgrepo-com.svg" alt="Tram icon" class="w-16 h-16 mr-4 mb-4 md:mb-0 md:mr-8 drop-shadow-lg"/>
            <div class="text-center md:text-left">
                <h1 class="text-5xl font-extrabold sbb-dark tracking-tight">SBB Travel Analyzer</h1>
                <p class="text-xl text-gray-600 mt-2 font-medium">All aboard for savings! Let's analyze your trips.</p>
            </div>
        </header>

        <!-- Phase 1: Upload -->
        <div id="upload-section" class="content-card p-8">
            <h2 class="text-3xl font-bold mb-4 flex items-center sbb-dark">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 sbb-red-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                1. Upload Your PDF Ticket Summary
            </h2>
            <p class="text-gray-600 mb-6">Select the order summary PDF from your SBB account. Your data stays private and is processed right here in your browser. <a href="#" id="show-instructions-link" class="text-red-700 underline font-semibold">Here's how.</a></p>
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-lg text-gray-600 file:mr-5 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-md file:font-semibold file:bg-red-100 file:sbb-red-text hover:file:bg-red-200 transition-colors cursor-pointer"/>
            </div>
            <div id="loader" class="hidden mt-6 flex items-center justify-center flex-col w-full">
                <div class="relative w-full max-w-2xl h-24" id="train-loader-track">
                    <!-- Track with ties -->
                    <svg class="absolute left-0 right-0 bottom-8 w-full h-6 z-0" viewBox="0 0 600 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0" y="10" width="600" height="4" rx="2" fill="#bbb"/>
                        <!-- Track ties -->
                        <g>
                            <!-- 20 ties evenly spaced -->
                            <g>
                                <rect x="0" y="6" width="3" height="12" fill="#888"/>
                                <rect x="30" y="6" width="3" height="12" fill="#888"/>
                                <rect x="60" y="6" width="3" height="12" fill="#888"/>
                                <rect x="90" y="6" width="3" height="12" fill="#888"/>
                                <rect x="120" y="6" width="3" height="12" fill="#888"/>
                                <rect x="150" y="6" width="3" height="12" fill="#888"/>
                                <rect x="180" y="6" width="3" height="12" fill="#888"/>
                                <rect x="210" y="6" width="3" height="12" fill="#888"/>
                                <rect x="240" y="6" width="3" height="12" fill="#888"/>
                                <rect x="270" y="6" width="3" height="12" fill="#888"/>
                                <rect x="300" y="6" width="3" height="12" fill="#888"/>
                                <rect x="330" y="6" width="3" height="12" fill="#888"/>
                                <rect x="360" y="6" width="3" height="12" fill="#888"/>
                                <rect x="390" y="6" width="3" height="12" fill="#888"/>
                                <rect x="420" y="6" width="3" height="12" fill="#888"/>
                                <rect x="450" y="6" width="3" height="12" fill="#888"/>
                                <rect x="480" y="6" width="3" height="12" fill="#888"/>
                                <rect x="510" y="6" width="3" height="12" fill="#888"/>
                                <rect x="540" y="6" width="3" height="12" fill="#888"/>
                                <rect x="570" y="6" width="3" height="12" fill="#888"/>
                            </g>
                        </g>
                    </svg>
                    <!-- Train -->
                    <div id="train-svg-wrapper" class="absolute z-10" style="transition: left 0.5s cubic-bezier(.4,2,.6,1); left:0; width:56px; bottom:22px;">
                        <svg viewBox="0 0 512 512" style="width:56px; height:auto; display:block; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.12));" xmlns="http://www.w3.org/2000/svg">
                            <g>
                                <path fill="#C2001B" d="M424.154,133.902H369.23l40.607-30.427L341.98,52.62l-67.856,50.855l40.607,30.427H197.27l40.607-30.427
                                    l-67.85-50.855l-67.856,50.855l40.607,30.427H87.846C39.323,133.909,0.014,173.224,0,221.747v174.089
                                    c-0.007,7.977,3.279,15.338,8.511,20.551c5.212,5.232,12.58,8.517,20.551,8.511h38.166c-0.047,0.649-0.196,1.264-0.196,1.92
                                    c0,17.988,14.575,32.563,32.563,32.563c17.982,0,32.562-14.575,32.562-32.563c0-0.656-0.149-1.271-0.196-1.92h19.09
                                    c-0.047,0.649-0.196,1.264-0.196,1.92c0,17.988,14.575,32.563,32.563,32.563c17.981,0,32.563-14.575,32.563-32.563
                                    c0-0.656-0.149-1.271-0.196-1.92h80.437c-0.041,0.649-0.196,1.264-0.196,1.92c0,17.988,14.574,32.563,32.563,32.563
                                    c17.981,0,32.563-14.575,32.563-32.563c0-0.656-0.149-1.271-0.196-1.92h19.09c-0.041,0.649-0.197,1.264-0.197,1.92
                                    c0,17.988,14.575,32.563,32.563,32.563c17.982,0,32.563-14.575,32.563-32.563c0-0.656-0.155-1.271-0.196-1.92h38.16
                                    c7.97,0.006,15.338-3.279,20.551-8.511c5.232-5.212,8.517-12.574,8.511-20.551V221.747
                                    C511.986,173.224,472.677,133.909,424.154,133.902z"/>
                                <rect x="98.027" y="240.189" width="58.324" height="116.656" fill="#444"/>
                                <rect x="217.921" y="240.189" width="68.052" height="58.331" fill="#444"/>
                                <rect x="345.921" y="240.189" width="68.052" height="58.331" fill="#444"/>
                            </g>
                        </svg>
                    </div>
                </div>
                <p id="loader-text" class="mt-2 text-gray-700 font-semibold text-lg" aria-live="polite">Reading PDF...</p>
            </div>
            <div id="error-message" class="hidden mt-4 text-red-800 bg-red-100 p-4 rounded-lg font-semibold"></div>
        </div>

        <!-- Phase 2: Verify Data -->
        <div id="verify-section" class="hidden mt-8 content-card p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold flex items-center sbb-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 sbb-red-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    2. Check Your Travel Log
                </h2>
                <button id="export-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition-transform hover:scale-105 shadow-md">Export to Excel</button>
            </div>
            <p class="text-gray-600 mb-4">The AI has extracted the following data. Click any cell to make corrections. For combined tickets, check the "Bike?" box to separate the bike pass cost.</p>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table id="data-table" class="min-w-full bg-white">
                    <thead class="bg-gray-700 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold">Travel Date</th>
                            <th class="py-3 px-4 text-left font-semibold">Route / Description</th>
                            <th class="py-3 px-4 text-left font-semibold">Ticket Type</th>
                            <th class="py-3 px-4 text-left font-semibold">Travelers</th>
                            <th class="py-3 px-4 text-left font-semibold">Price (CHF)</th>
                            <th class="py-3 px-4 text-left font-semibold">Refunded?</th>
                            <th class="py-3 px-4 text-center font-semibold">Bike?</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-200">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Phase 3: Analyze -->
        <div id="analyze-section" class="hidden mt-8 content-card p-8">
             <h2 class="text-3xl font-bold mb-6 flex items-center sbb-dark">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 sbb-red-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                3. Model Your Future Costs
            </h2>
            <p class="text-gray-600 mb-6">Select a period from your history to use as a basis for the cost model.</p>
            <div class="grid md:grid-cols-3 gap-6 items-end">
                <div>
                    <label for="date-range-select" class="block text-sm font-medium text-gray-700 mb-1">Basis for Model</label>
                    <select id="date-range-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <option value="3">Last 3 Months</option>
                        <option value="6">Last 6 Months</option>
                        <option value="12">Last Year</option>
                        <option value="1">Last Month</option>
                        <option value="custom">Custom Range...</option>
                    </select>
                </div>
                <div id="custom-date-range" class="hidden grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="start-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                     <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="end-date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                </div>
                <div>
                    <label for="user-age" class="block text-sm font-medium text-gray-700 mb-1">Your Age</label>
                    <input type="number" id="user-age" value="30" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <button id="analyze-btn" class="w-full sbb-red text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-all hover:scale-105 shadow-lg text-lg">Analyze My Travel!</button>
            </div>
        </div>
        
        <!-- Phase 4: Results & Visualization -->
        <div id="results-section" class="hidden mt-8">
            <div class="content-card p-8">
                 <h2 class="text-3xl font-bold mb-4 flex items-center sbb-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 sbb-red-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" /></svg>
                    Your Golden Ticket to Savings
                </h2>
                <div id="recommendation-output" class="text-lg p-6 bg-red-50 border-l-4 border-red-500 rounded-r-lg mt-6"></div>
            </div>

            <!-- AI Insights Section -->
            <div class="mt-8 content-card p-8">
                <h2 class="text-3xl font-bold mb-6 flex items-center sbb-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 sbb-red-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    AI Travel Insights
                </h2>
                <div id="ai-insights" class="text-lg p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-r-lg">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                        <span class="text-blue-700">Analyzing your travel patterns...</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Travel Dashboard -->
            <div class="mt-8 content-card p-8">
                <h2 class="text-3xl font-bold mb-6 flex items-center sbb-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 sbb-red-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                    Travel Analytics Dashboard
                </h2>
                
                <!-- Key Metrics Row -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl border border-red-200">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-red-600">Total Trips</p>
                                <p id="total-trips" class="text-2xl font-bold text-red-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-blue-600">Total Spent</p>
                                <p id="total-spent" class="text-2xl font-bold text-blue-800">0 CHF</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-green-600">Travelers</p>
                                <p id="unique-travelers" class="text-2xl font-bold text-green-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-purple-600">Avg Trip Cost</p>
                                <p id="avg-trip-cost" class="text-2xl font-bold text-purple-800">0 CHF</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Charts Grid -->
                <div class="grid lg:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-center sbb-dark">Spending by Ticket Type</h3>
                        <div class="chart-container">
                            <canvas id="type-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-center sbb-dark">Monthly Spending Trend</h3>
                        <div class="chart-container">
                            <canvas id="monthly-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Travel Patterns Row -->
                <div class="grid lg:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-center sbb-dark">Travel Frequency by Day of Week</h3>
                        <div class="chart-container">
                            <canvas id="day-of-week-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-center sbb-dark">Top Travelers</h3>
                        <div class="chart-container">
                            <canvas id="travelers-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Route Analysis -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-center sbb-dark">Popular Routes & Destinations</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="chart-container">
                            <canvas id="routes-chart"></canvas>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h4 class="font-semibold mb-3 text-gray-700">Route Insights</h4>
                            <div id="route-insights" class="space-y-2 text-sm text-gray-600">
                                <!-- Route insights will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Comparison -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-center sbb-dark">Cost Comparison by Travel Option</h3>
                    <div class="chart-container" style="height: 50vh;">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-8 relative animate-fade-in border-t-8 border-[#EB0000]">
                <button id="close-instructions-modal" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
                <h2 class="text-2xl font-bold mb-4" style="color:#EB0000;">How to Download Your SBB Ticket Orders PDF</h2>
                <ol class="list-decimal list-inside space-y-2" style="color:#444;">
                    <li>Sign In: Go to the <a href="https://www.sbb.ch/en/buying/pages/bestellung/bestellungen.xhtml" target="_blank" class="text-red-700 underline">SBB orders page</a> and log in with your SwissPass account.</li>
                    <li>Set Time Period: In the "Select period" section, choose <b>Last year</b>.</li>
                    <li>Search: Click the <b>Search orders</b> button.</li>
                    <li>Select All: Tick the checkbox at the top of the list to select all your orders.</li>
                    <li>Export PDF: Click on <b>Print tickets</b> to save the PDF file.</li>
                </ol>
            </div>
        </div>

    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const SBB_PRICES = {
            GA_ADULT: 3995,
            GA_YOUTH: 3495, // Age 16-25
            HALF_FARE: 190,
            BIKE_PASS: 240,
            DAY_BIKE_PASS: 14, // Assumed cost for a day bike pass with half-fare
            DAY_BIKE_PASS_FULL: 28, // Full price bike pass (no half-fare)
            HALF_FARE_PLUS: [
                { name: "Half-Fare PLUS 1000", cost: 800, credit: 1000, url: "https://www.sbb.ch/en/travelcards-and-tickets/railpasses/half-fare-travelcard/half-fare-plus.html" },
                { name: "Half-Fare PLUS 2000", cost: 1500, credit: 2000, url: "https://www.sbb.ch/en/travelcards-and-tickets/railpasses/half-fare-travelcard/half-fare-plus.html" },
                { name: "Half-Fare PLUS 3000", cost: 2100, credit: 3000, url: "https://www.sbb.ch/en/travelcards-and-tickets/railpasses/half-fare-travelcard/half-fare-plus.html" }
            ]
        };

        const SBB_LINKS = {
            HALF_FARE: "https://www.sbb.ch/en/travelcards-and-tickets/railpasses/half-fare-travelcard.html",
            GA: "https://www.sbb.ch/en/travelcards-and-tickets/railpasses/ga-travelcard.html",
            BIKE_PASS: "https://www.sbb.ch/en/travelcards-and-tickets/railpasses/bike-pass.html"
        };

        // --- DOM ELEMENTS ---
        const uploadInput = document.getElementById('pdf-upload');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const errorMessage = document.getElementById('error-message');
        const verifySection = document.getElementById('verify-section');
        const analyzeSection = document.getElementById('analyze-section');
        const resultsSection = document.getElementById('results-section');
        const tableBody = document.getElementById('table-body');
        const analyzeBtn = document.getElementById('analyze-btn');
        const exportBtn = document.getElementById('export-btn');
        const dateRangeSelect = document.getElementById('date-range-select');
        const customDateRangeDiv = document.getElementById('custom-date-range');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        let travelData = [];
        let typeChartInstance, monthlyChartInstance, dayOfWeekChartInstance, travelersChartInstance, routesChartInstance;

        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        uploadInput.addEventListener('change', handleFileUpload);
        analyzeBtn.addEventListener('click', runAnalysis);
        exportBtn.addEventListener('click', exportToExcel);
        dateRangeSelect.addEventListener('change', handleDateSelection);

        function handleDateSelection() {
            if (dateRangeSelect.value === 'custom') {
                customDateRangeDiv.classList.remove('hidden');
                customDateRangeDiv.classList.add('grid');
            } else {
                customDateRangeDiv.classList.add('hidden');
                customDateRangeDiv.classList.remove('grid');
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            resetUI();
            loader.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            try {
                loaderText.textContent = 'Reading your PDF...';
                const pdf = await parsePdf(file);
                const totalPages = pdf.numPages;
                
                if (totalPages > 20) {
                    showError("This PDF is quite large (" + totalPages + " pages). Processing may take a while and use more API calls. Consider splitting it into smaller files.");
                    loader.classList.add('hidden');
                    return;
                }
                
                loaderText.textContent = 'The AI conductor is checking your tickets...';
                let allData = [];
                
                // Process 2 pages at a time to reduce API calls
                for (let i = 0; i < totalPages; i += 2) {
                    const pageNumbers = [];
                    let combinedText = '';
                    
                    // Get current page and next page (if it exists)
                    for (let j = 0; j < 2 && (i + j) < totalPages; j++) {
                        const pageNum = i + j + 1;
                        pageNumbers.push(pageNum);
                        const pageText = await extractTextFromPage(pdf, pageNum);
                        combinedText += `=== PAGE ${pageNum} ===\n${pageText}\n`;
                    }
                    
                    updateLoaderProgress(Math.min(i + 2, totalPages), totalPages);
                    
                    const pageData = await extractDataWithAI(combinedText, pageNumbers, totalPages);
                    
                    if (pageData && pageData.length > 0) {
                        allData = allData.concat(pageData);
                    }
                    
                    // Small delay to avoid overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                travelData = allData;
                renderTable(travelData);
                verifySection.classList.remove('hidden');
                analyzeSection.classList.remove('hidden');
                loader.classList.add('hidden');
                
                if (allData.length === 0) {
                    showError("No ticket data found in the PDF. Please check if this is the correct SBB order summary file.");
                }
                
            } catch (error) {
                console.error("Error processing file:", error);
                showError("The train has been delayed! Failed to process the PDF. It might be corrupted, password-protected, or in an unexpected format. Please try again.");
                loader.classList.add('hidden');
            }
        }

        async function parsePdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            return pdf;
        }

        async function extractTextFromPage(pdf, pageNumber) {
            const page = await pdf.getPage(pageNumber);
            const textContent = await page.getTextContent();
            return textContent.items.map(item => item.str).join(' ') + '\n\n';
        }

        async function extractDataWithAI(text, pageNumbers, totalPages) {
            try {
                const response = await fetch('/.netlify/functions/process-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text, pageNumbers, totalPages })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }

                const result = await response.json();
                return result.data;
            } catch (error) {
                console.error('Error calling serverless function:', error);
                throw new Error(`Failed to process PDF: ${error.message}`);
            }
        }

        async function generateAIInsights(data) {
            try {
                // Prepare condensed data for AI analysis
                const condensedData = {
                    totalTrips: data.length,
                    dateRange: {
                        start: new Date(Math.min(...data.map(d => new Date(d.travelDate)))),
                        end: new Date(Math.max(...data.map(d => new Date(d.travelDate))))
                    },
                    ticketTypes: data.reduce((acc, item) => {
                        acc[item.ticketType] = (acc[item.ticketType] || 0) + 1;
                        return acc;
                    }, {}),
                    travelers: data.reduce((acc, item) => {
                        item.travelers.forEach(traveler => {
                            acc[traveler] = (acc[traveler] || 0) + 1;
                        });
                        return acc;
                    }, {}),
                    routes: data.reduce((acc, item) => {
                        const route = item.description;
                        acc[route] = (acc[route] || 0) + 1;
                        return acc;
                    }, {}),
                    totalSpent: data.reduce((sum, item) => sum + item.price, 0),
                    dayOfWeekPattern: data.reduce((acc, item) => {
                        const day = new Date(item.travelDate).toLocaleDateString('en-US', { weekday: 'long' });
                        acc[day] = (acc[day] || 0) + 1;
                        return acc;
                    }, {})
                };

                const prompt = `
                    Analyze this Swiss SBB travel data and provide insights about travel patterns. 
                    Focus on identifying:
                    1. Commuting patterns (how many times per week they likely commute)
                    2. Weekend travel patterns (how many weekend trips per month)
                    3. Travel frequency and habits
                    4. Any notable patterns in routes or destinations
                    
                    Be conversational and insightful. Format as a friendly analysis paragraph.
                    
                    Data: ${JSON.stringify(condensedData, null, 2)}
                `;

                const response = await fetch('/.netlify/functions/process-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        text: prompt, 
                        pageNumbers: [1], 
                        totalPages: 1,
                        isInsightRequest: true 
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI insights request failed: ${response.status}`);
                }

                const result = await response.json();
                const insightsDiv = document.getElementById('ai-insights');
                insightsDiv.innerHTML = `<div class="prose max-w-none">
                    <p class="text-lg leading-relaxed text-gray-800">${result.data}</p>
                </div>`;
            } catch (error) {
                console.error('Error generating AI insights:', error);
                const insightsDiv = document.getElementById('ai-insights');
                insightsDiv.innerHTML = `<div class="text-red-600">
                    <p>Unable to generate AI insights at this time. Please try again later.</p>
                </div>`;
            }
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-red-50 transition-colors';
                
                let bikeCheckboxHtml = '';
                if (item.ticketType === 'Point-to-point' && item.price > 15) {
                    bikeCheckboxHtml = `<input type="checkbox" class="bike-checkbox" data-index="${index}">`;
                }

                row.innerHTML = `
                    <td class="py-3 px-4" contenteditable="true" data-index="${index}" data-field="travelDate">${item.travelDate}</td>
                    <td class="py-3 px-4" contenteditable="true" data-index="${index}" data-field="description">${item.description}</td>
                    <td class="py-3 px-4" contenteditable="true" data-index="${index}" data-field="ticketType">${item.ticketType}</td>
                    <td class="py-3 px-4" contenteditable="true" data-index="${index}" data-field="travelers">${item.travelers.join(', ')}</td>
                    <td class="py-3 px-4" contenteditable="true" data-index="${index}" data-field="price">${item.price.toFixed(2)}</td>
                    <td class="py-3 px-4" contenteditable="true" data-index="${index}" data-field="isRefunded">${item.isRefunded}</td>
                    <td class="py-3 px-4 text-center">${bikeCheckboxHtml}</td>
                `;
                tableBody.appendChild(row);
            });
            tableBody.addEventListener('input', updateTravelDataFromTable);
        }

        function updateTravelDataFromTable(event) {
            const target = event.target;
            const index = target.dataset.index;
            const field = target.dataset.field;
            let value = target.textContent;
            if (field === 'price') value = parseFloat(value) || 0;
            if (field === 'isRefunded') value = value.toLowerCase() === 'true';
            if (field === 'travelers') value = value.split(',').map(name => name.trim());
            travelData[index][field] = value;
        }

        function runAnalysis() {
            let startDate, endDate;
            const rangeValue = dateRangeSelect.value;

            if (rangeValue === 'custom') {
                startDate = new Date(startDateInput.value);
                endDate = new Date(endDateInput.value);
            } else {
                endDate = new Date();
                startDate = new Date();
                startDate.setMonth(endDate.getMonth() - parseInt(rangeValue));
            }

            if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
                showError("Please select a valid date range.");
                return;
            }

            const daysInRange = (endDate - startDate) / (1000 * 60 * 60 * 24) + 1;
            const scalingFactor = 365 / daysInRange;

            const filteredData = travelData.filter(item => {
                const itemDate = new Date(item.travelDate);
                return itemDate >= startDate && itemDate <= endDate && !item.isRefunded;
            });
            
            // Process bike checkboxes
            let manualBikeCost = 0;
            const processedData = filteredData.map((item, index) => {
                const checkbox = document.querySelector(`.bike-checkbox[data-index="${index}"]`);
                if (checkbox && checkbox.checked) {
                    manualBikeCost += SBB_PRICES.DAY_BIKE_PASS;
                    return {...item, price: item.price - SBB_PRICES.DAY_BIKE_PASS};
                }
                return item;
            });

            const dataWithCardInfo = inferCardUsage(travelData);
            const bikeTickets = processedData.filter(item => item.ticketType === 'Bike');
            const otherTickets = processedData.filter(item => item.ticketType !== 'Bike');
            const bikeSpendingInPeriod = bikeTickets.reduce((sum, item) => sum + item.price, 0) + manualBikeCost;
            const projectedBikeSpending = bikeSpendingInPeriod * scalingFactor;
            const bikeRecommendation = {
                projectedSpending: projectedBikeSpending,
                passCost: SBB_PRICES.BIKE_PASS,
                isRecommended: projectedBikeSpending > SBB_PRICES.BIKE_PASS
            };

            // Calculate baseline costs (no cards)
            let baselineCost = 0;
            otherTickets.forEach(item => {
                const originalItem = dataWithCardInfo.find(d => d.travelDate === item.travelDate && d.description === item.description);
                if (originalItem && originalItem.usedHalfFare && item.ticketType !== 'Travelcard') {
                    baselineCost += item.price * 2;
                } else {
                    baselineCost += item.price;
                }
            });
            const projectedBaseline = baselineCost * scalingFactor;

            // Calculate Half-Fare Card costs
            const halfFareTicketsCost = otherTickets.reduce((sum, item) => item.ticketType !== 'Travelcard' ? sum + item.price : sum, 0);
            const projectedHalfFareTicketsCost = halfFareTicketsCost * scalingFactor;
            const projectedHalfFareTotal = projectedHalfFareTicketsCost + SBB_PRICES.HALF_FARE;

            // Calculate Half-Fare PLUS options
            const age = parseInt(document.getElementById('user-age').value);
            const hfPlusOptions = SBB_PRICES.HALF_FARE_PLUS.map(tier => {
                const remainingCost = Math.max(0, projectedHalfFareTicketsCost - tier.credit);
                const totalCost = SBB_PRICES.HALF_FARE + tier.cost + remainingCost;
                return {
                    name: tier.name,
                    cardCost: SBB_PRICES.HALF_FARE + tier.cost,
                    ticketCost: remainingCost,
                    totalCost: totalCost,
                    url: tier.url
                };
            });

            // Calculate GA costs (including bike tickets at full price)
            const gaPrice = age <= 25 && age >= 16 ? SBB_PRICES.GA_YOUTH : SBB_PRICES.GA_ADULT;
            const projectedBikeCostWithGA = projectedBikeSpending * (SBB_PRICES.DAY_BIKE_PASS_FULL / SBB_PRICES.DAY_BIKE_PASS); // GA doesn't cover bikes
            const gaTotal = gaPrice + projectedBikeCostWithGA;

            // Prepare cost breakdowns
            const costBreakdowns = {
                "No Card": {
                    cardCost: 0,
                    ticketCost: projectedBaseline,
                    bikeCost: projectedBikeSpending,
                    totalCost: projectedBaseline + projectedBikeSpending
                },
                "Half-Fare Card": {
                    cardCost: SBB_PRICES.HALF_FARE,
                    ticketCost: projectedHalfFareTicketsCost,
                    bikeCost: projectedBikeSpending,
                    totalCost: projectedHalfFareTotal + projectedBikeSpending
                },
                ...Object.fromEntries(hfPlusOptions.map(option => [
                    option.name,
                    {
                        cardCost: option.cardCost,
                        ticketCost: option.ticketCost,
                        bikeCost: projectedBikeSpending,
                        totalCost: option.totalCost + projectedBikeSpending,
                        url: option.url
                    }
                ])),
                "GA Travelcard": {
                    cardCost: gaPrice,
                    ticketCost: 0,
                    bikeCost: projectedBikeCostWithGA,
                    totalCost: gaTotal
                }
            };

            const bestOption = Object.keys(costBreakdowns).reduce((a, b) => 
                costBreakdowns[a].totalCost < costBreakdowns[b].totalCost ? a : b
            );
            const savings = costBreakdowns["No Card"].totalCost - costBreakdowns[bestOption].totalCost;
            
            displayRecommendation(costBreakdowns, bestOption, savings, bikeRecommendation);
            generateComparisonChart(costBreakdowns);
            generateEnhancedVisualizations(processedData);
            generateAIInsights(processedData);
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function inferCardUsage(allData) {
            const cardPurchases = {};
            allData.forEach(item => {
                if (item.ticketType === 'Travelcard' && item.description.toLowerCase().includes('half fare')) {
                    item.travelers.forEach(traveler => { cardPurchases[traveler] = new Date(item.travelDate); });
                }
            });
            return allData.map(item => {
                let usedHalfFare = false;
                item.travelers.forEach(traveler => {
                    if (cardPurchases[traveler]) {
                        const purchaseDate = cardPurchases[traveler];
                        const expiryDate = new Date(purchaseDate);
                        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                        const itemDate = new Date(item.travelDate);
                        if (itemDate >= purchaseDate && itemDate <= expiryDate) usedHalfFare = true;
                    }
                });
                return { ...item, usedHalfFare };
            });
        }

        function displayRecommendation(costBreakdowns, bestOption, savings, bikeRec) {
            const outputDiv = document.getElementById('recommendation-output');
            const bikeSavings = bikeRec.projectedSpending - bikeRec.passCost;
            
            let bikeHtml = `<div class="mb-6 pb-4 border-b border-gray-300">
                <h3 class="font-bold text-xl mb-2 sbb-dark">Bike Pass Analysis</h3>
                <p>Your projected annual spending on bike tickets is <b>${bikeRec.projectedSpending.toFixed(2)} CHF</b>.</p>`;
            if (bikeRec.isRecommended) {
                bikeHtml += `<p class="mt-2 font-bold text-green-700">An annual Bike Pass (${SBB_PRICES.BIKE_PASS} CHF) is recommended. It could save you ~${bikeSavings.toFixed(2)} CHF.</p>`;
            } else {
                bikeHtml += `<p class="mt-2 font-semibold text-orange-600">An annual Bike Pass is likely not worth it. Sticking with individual tickets is cheaper.</p>`;
            }
            bikeHtml += `<p class="mt-2 text-sm text-gray-600"><a href="${SBB_LINKS.BIKE_PASS}" target="_blank" class="text-blue-600 hover:underline">Learn more about Bike Pass →</a></p>`;
            bikeHtml += `<p class="mt-2 text-sm text-orange-600"><strong>Note:</strong> GA Travelcard does not include bike transport - you'll need to pay full price for bike tickets.</p></div>`;

            let mainHtml = `<p class="font-bold text-xl mb-3 sbb-dark">Your best option is the <span class="sbb-red-text">${bestOption}</span>!</p>`;
            
            // Create detailed breakdown table
            mainHtml += `<div class="overflow-x-auto mt-4">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-2 px-3 text-left font-semibold text-gray-700">Option</th>
                            <th class="py-2 px-3 text-left font-semibold text-gray-700">Card Cost</th>
                            <th class="py-2 px-3 text-left font-semibold text-gray-700">Tickets</th>
                            <th class="py-2 px-3 text-left font-semibold text-gray-700">Bike</th>
                            <th class="py-2 px-3 text-left font-semibold text-gray-700">Total</th>
                            <th class="py-2 px-3 text-left font-semibold text-gray-700">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">`;
            
            Object.entries(costBreakdowns).forEach(([option, breakdown]) => {
                const isBest = option === bestOption;
                const rowClass = isBest ? 'bg-green-50 border-l-4 border-green-500' : '';
                const totalClass = isBest ? 'font-bold text-green-700' : 'font-semibold';
                
                mainHtml += `<tr class="${rowClass}">
                    <td class="py-2 px-3 font-medium">${option}${isBest ? ' 🏆' : ''}</td>
                    <td class="py-2 px-3">${breakdown.cardCost.toFixed(2)} CHF</td>
                    <td class="py-2 px-3">${breakdown.ticketCost.toFixed(2)} CHF</td>
                    <td class="py-2 px-3">${breakdown.bikeCost.toFixed(2)} CHF</td>
                    <td class="py-2 px-3 ${totalClass}">${breakdown.totalCost.toFixed(2)} CHF</td>
                    <td class="py-2 px-3">`;
                
                if (breakdown.url) {
                    mainHtml += `<a href="${breakdown.url}" target="_blank" class="text-blue-600 hover:underline text-sm">Learn more →</a>`;
                } else if (option === "Half-Fare Card") {
                    mainHtml += `<a href="${SBB_LINKS.HALF_FARE}" target="_blank" class="text-blue-600 hover:underline text-sm">Learn more →</a>`;
                } else if (option === "GA Travelcard") {
                    mainHtml += `<a href="${SBB_LINKS.GA}" target="_blank" class="text-blue-600 hover:underline text-sm">Learn more →</a>`;
                }
                
                mainHtml += `</td></tr>`;
            });
            
            mainHtml += `</tbody></table></div>`;
            mainHtml += `<p class="mt-4 font-bold text-green-700">By choosing the ${bestOption}, you could save approximately ${savings.toFixed(2)} CHF per year compared to paying full price.</p>`;
            
            outputDiv.innerHTML = bikeHtml + mainHtml;
        }
        
        function generateComparisonChart(costBreakdowns) {
            const options = Object.keys(costBreakdowns);
            const cardCosts = options.map(option => costBreakdowns[option].cardCost);
            const ticketCosts = options.map(option => costBreakdowns[option].ticketCost);
            const bikeCosts = options.map(option => costBreakdowns[option].bikeCost);
            
            const ctx = document.getElementById('comparison-chart').getContext('2d');
            if (window.comparisonChartInstance) window.comparisonChartInstance.destroy();
            
            window.comparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: options,
                    datasets: [
                        {
                            label: 'Card Cost',
                            data: cardCosts,
                            backgroundColor: '#EB0000',
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Ticket Cost',
                            data: ticketCosts,
                            backgroundColor: '#0079c9',
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Bike Cost',
                            data: bikeCosts,
                            backgroundColor: '#4caf50',
                            stack: 'Stack 0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Annual Cost (CHF)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const option = options[dataIndex];
                                    const breakdown = costBreakdowns[option];
                                    return [
                                        `Total: ${breakdown.totalCost.toFixed(2)} CHF`,
                                        breakdown.url ? `Learn more: ${breakdown.url}` : ''
                                    ].filter(Boolean);
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateEnhancedVisualizations(data) {
            // Update key metrics
            const totalTrips = data.length;
            const totalSpent = data.reduce((sum, item) => sum + item.price, 0);
            const avgTripCost = totalSpent / totalTrips;
            const uniqueTravelers = new Set(data.flatMap(item => item.travelers)).size;

            document.getElementById('total-trips').textContent = totalTrips;
            document.getElementById('total-spent').textContent = `${totalSpent.toFixed(2)} CHF`;
            document.getElementById('unique-travelers').textContent = uniqueTravelers;
            document.getElementById('avg-trip-cost').textContent = `${avgTripCost.toFixed(2)} CHF`;

            // Chart colors
            const chartColors = ['#EB0000', '#0079c9', '#ffcb05', '#4caf50', '#9c27b0', '#795548', '#607d8b'];

            // 1. Spending by Ticket Type (Pie Chart)
            const typeSpending = data.reduce((acc, item) => {
                if (item.ticketType !== 'Travelcard') acc[item.ticketType] = (acc[item.ticketType] || 0) + item.price;
                return acc;
            }, {});
            const typeCtx = document.getElementById('type-chart').getContext('2d');
            if (typeChartInstance) typeChartInstance.destroy();
            typeChartInstance = new Chart(typeCtx, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(typeSpending), 
                    datasets: [{ 
                        data: Object.values(typeSpending), 
                        backgroundColor: chartColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed.toFixed(2)} CHF (${percentage}%)`;
                                }
                            }
                        }
                    } 
                }
            });

            // 2. Monthly Spending Trend (Line Chart)
            const monthlySpending = data.reduce((acc, item) => {
                const month = new Date(item.travelDate).toLocaleString('default', { month: 'short', year: '2-digit' });
                acc[month] = (acc[month] || 0) + item.price;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlySpending).sort((a,b) => new Date(`01 ${a.replace("'"," 20")}`) - new Date(`01 ${b.replace("'"," 20")}`));
            const sortedSpending = sortedMonths.map(month => monthlySpending[month]);
            const monthlyCtx = document.getElementById('monthly-chart').getContext('2d');
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'line',
                data: { 
                    labels: sortedMonths, 
                    datasets: [{ 
                        label: 'Monthly Spending (CHF)', 
                        data: sortedSpending, 
                        backgroundColor: 'rgba(235, 0, 0, 0.1)',
                        borderColor: '#EB0000',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Spending (CHF)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }, 
                    plugins: { 
                        legend: { display: false } 
                    } 
                }
            });

            // 3. Day of Week Pattern (Bar Chart)
            const dayOfWeekData = data.reduce((acc, item) => {
                const day = new Date(item.travelDate).toLocaleDateString('en-US', { weekday: 'long' });
                acc[day] = (acc[day] || 0) + 1;
                return acc;
            }, {});
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayOfWeekCtx = document.getElementById('day-of-week-chart').getContext('2d');
            if (dayOfWeekChartInstance) dayOfWeekChartInstance.destroy();
            dayOfWeekChartInstance = new Chart(dayOfWeekCtx, {
                type: 'bar',
                data: { 
                    labels: dayOrder.filter(day => dayOfWeekData[day]), 
                    datasets: [{ 
                        label: 'Trips', 
                        data: dayOrder.filter(day => dayOfWeekData[day]).map(day => dayOfWeekData[day]), 
                        backgroundColor: '#0079c9',
                        borderRadius: 8
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Trips'
                            }
                        }
                    }, 
                    plugins: { 
                        legend: { display: false } 
                    } 
                }
            });

            // 4. Top Travelers (Horizontal Bar Chart)
            const travelerData = data.reduce((acc, item) => {
                item.travelers.forEach(traveler => {
                    acc[traveler] = (acc[traveler] || 0) + 1;
                });
                return acc;
            }, {});
            const sortedTravelers = Object.entries(travelerData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            const travelersCtx = document.getElementById('travelers-chart').getContext('2d');
            if (travelersChartInstance) travelersChartInstance.destroy();
            travelersChartInstance = new Chart(travelersCtx, {
                type: 'bar',
                data: { 
                    labels: sortedTravelers.map(([name]) => name), 
                    datasets: [{ 
                        label: 'Trips', 
                        data: sortedTravelers.map(([,count]) => count), 
                        backgroundColor: '#4caf50',
                        borderRadius: 8
                    }] 
                },
                options: { 
                    indexAxis: 'y',
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        x: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Trips'
                            }
                        }
                    }, 
                    plugins: { 
                        legend: { display: false } 
                    } 
                }
            });

            // 5. Popular Routes (Bar Chart)
            const routeData = data.reduce((acc, item) => {
                const route = item.description;
                acc[route] = (acc[route] || 0) + 1;
                return acc;
            }, {});
            const sortedRoutes = Object.entries(routeData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            const routesCtx = document.getElementById('routes-chart').getContext('2d');
            if (routesChartInstance) routesChartInstance.destroy();
            routesChartInstance = new Chart(routesCtx, {
                type: 'bar',
                data: { 
                    labels: sortedRoutes.map(([route]) => route.length > 30 ? route.substring(0, 30) + '...' : route), 
                    datasets: [{ 
                        label: 'Frequency', 
                        data: sortedRoutes.map(([,count]) => count), 
                        backgroundColor: '#9c27b0',
                        borderRadius: 8
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Trips'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const routeIndex = context[0].dataIndex;
                                    return sortedRoutes[routeIndex][0];
                                }
                            }
                        }
                    } 
                }
            });

            // 6. Route Insights
            generateRouteInsights(data);
        }

        function generateRouteInsights(data) {
            const insightsDiv = document.getElementById('route-insights');
            const routeData = data.reduce((acc, item) => {
                const route = item.description;
                acc[route] = (acc[route] || 0) + 1;
                return acc;
            }, {});
            
            const sortedRoutes = Object.entries(routeData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            let insightsHtml = '';
            sortedRoutes.forEach(([route, count], index) => {
                const percentage = ((count / data.length) * 100).toFixed(1);
                insightsHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <div>
                            <span class="font-medium text-gray-800">${route}</span>
                            <span class="text-gray-500 text-xs ml-2">(${percentage}% of trips)</span>
                        </div>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium">
                            ${count} trips
                        </span>
                    </div>
                `;
            });

            insightsDiv.innerHTML = insightsHtml;
        }

        function exportToExcel() {
            const exportData = travelData.map(item => ({ ...item, travelers: item.travelers.join(', ') }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "SBB Travel Data");
            XLSX.writeFile(wb, "sbb_travel_analysis.xlsx");
        }
        
        function resetUI() {
            verifySection.classList.add('hidden');
            analyzeSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorMessage.classList.add('hidden');
            tableBody.innerHTML = '';
            travelData = [];
            dateRangeSelect.value = '3';
            handleDateSelection();
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // PDF loader progress update (no batching mention)
        function updateLoaderProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            loaderText.textContent = `Processing page ${current} of ${total}... (${percent}%)`;
            // Move train
            const track = document.getElementById('train-loader-track');
            const train = document.getElementById('train-svg-wrapper');
            if (track && train) {
                const trackWidth = track.offsetWidth - train.offsetWidth;
                // Prevent overflow at 0% and 100%
                const progress = Math.max(0, Math.min(1, (current-1) / (total-1)));
                train.style.left = `${progress * trackWidth}px`;
            }
        }

        // Modal instructions logic
        const showInstructionsLink = document.getElementById('show-instructions-link');
        const instructionsModal = document.getElementById('instructions-modal');
        const closeInstructionsModal = document.getElementById('close-instructions-modal');
        showInstructionsLink.addEventListener('click', (e) => {
            e.preventDefault();
            instructionsModal.classList.remove('hidden');
        });
        closeInstructionsModal.addEventListener('click', () => {
            instructionsModal.classList.add('hidden');
        });
        instructionsModal.addEventListener('click', (e) => {
            if (e.target === instructionsModal) instructionsModal.classList.add('hidden');
        });
    </script>
    <footer class="mt-16 mb-4 text-center text-gray-400 text-sm font-medium select-none">
        © allmydogseat 2025
    </footer>
</body>
</html>
